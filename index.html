<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Computing App</title>
		<meta name="author" content="Dalian Barzellino">
		<meta name="viewport" content="width=device-width; initial-scale=1.0">
		<!-- Latest compiled and minified CSS BootStrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

		<!-- Latest compiled JavaScript BootStrap -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<link rel="stylesheet" type="text/css" href="style.css" />

		<!-- Add an original police -->
		<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">

		<script src="https://zumo.blob.core.windows.net/sdk/azure-mobile-apps-client.min.js"></script>

	</head>

	<body>
		  <script>
		  	var client = new WindowsAzure.MobileServiceClient("http://smsanalysisapp.azurewebsites.net");
		  	var table = client.getTable("SmsTable");
		  	var result;

		  	function success(results) {
		  		console.log("Read success.");
				var numItemsRead = results.length;

				for (var i = 0 ; i < results.length ; i++) {
					// Handling only the last line of the table
					if (i == results.length - 1) {
						var row = results[i].Text;
						var smsArray = row.match(/\[(.*?)\]/gi);

						var numArray = new Map();
				   		for (let i = 0; i < smsArray.length; i++) {
				   			let firstNum = smsArray[i].split(",")[0].split("[")[1];
				   			if (numArray.has(firstNum)) {
				   				numArray.set(firstNum, numArray.get(firstNum) + 1)
				   			} else {
				   				numArray.set(firstNum, 1)
				   			}
				   		}

				   		result = mostContacted(numArray);
				   		console.log("result = " + result);
				   		
				   		sendData(result);
					}
				}
			}

			function failure(error) {
				console.log("Read fail.");
				throw new Error('Error loading data: ', error);
			}

			function mostContacted(map) {
				var maxkey = 0;
				var maxval = 0;
				for (var [key, value] of map) {
					if (value > maxval) {
						maxkey = key;
						maxval = value;
					}
				}

				return maxkey;
			}

			function sendData(res) {
				
			}

			// Script execution

			table.read().then(success, failure);


		  </script>

	</body>

</html>