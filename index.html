<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Computing App</title>
		<meta name="author" content="Dalian Barzellino">
		<meta name="viewport" content="width=device-width; initial-scale=1.0">
		<!-- Latest compiled and minified CSS BootStrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

		<!-- Latest compiled JavaScript BootStrap -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

		<link rel="stylesheet" type="text/css" href="style.css" />

		<!-- Add an original police -->
		<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">

		<script src="https://zumo.blob.core.windows.net/sdk/azure-mobile-apps-client.min.js"></script>

		<script src='./js/randomForest.js'></script>

	</head>

	<body>
		  <script>
		  	var client = new WindowsAzure.MobileServiceClient("http://smsanalysisapp.azurewebsites.net");
		  	var table = client.getTable("SmsTable");
		  	var tableRes = client.getTable("ResultTable");
		  	var learner;
		  	var intervalId;
		  	var result;

		  	function success(results) {
		  		//console.log("Read success.");
				var numItemsRead = results.length;

				for (var i = 0 ; i < results.length ; i++) {
					// Handling only the last line of the table
					if (i == results.length - 1) {
						var row = results[i].Text;

						// Using the machine learning algorithm
						let cleanData = cleanUp(results[i].Text);
						console.log(cleanData);

						// Computing the most contacted person
						var smsArray = row.match(/\[(.*?)\]/gi);

						var numArray = new Map();
				   		for (let i = 0; i < smsArray.length; i++) {
				   			let firstNum = smsArray[i].split(",")[0].split("[")[1];
				   			if (numArray.has(firstNum)) {
				   				numArray.set(firstNum, numArray.get(firstNum) + 1)
				   			} else {
				   				numArray.set(firstNum, 1)
				   			}
				   		}

				   		result = mostContacted(numArray);
				   		
				   		updateData(result);

	   					//postSuccess();
					}
				}
			}

			function cleanUp(data) {
				var splitData = data.split('=');
				var cleanedData1 = [];
				var cleanedData2 = [];
				var dataAmount = 100;

				for (let i = 1; i < dataAmount; i++) {
					cleanedData1.push(splitData[i].substring(0, splitData[i].length - 4));
				}
				cleanedData1.push(splitData[dataAmount].substring(0, splitData[dataAmount].length - 1));
				
				cleanedData1.forEach(function (i) {
					let tmpData = [];
					i.split(', ').forEach(function (j) {
						if (j[0] == '[') {
							j = j.substring(1, j.length);
						} else if (j[j.length -1] == ']') {
							j = j.substring(0, j.length - 1);
						}
						tmpData.push(j);
					})
					cleanedData2.push(tmpData);
				});

				return cleanedData2;
			}

			function failure(error) {
				//console.log("Failure.");
				throw new Error('Error loading data: ', error);
			}

			function mostContacted(map) {
				var maxkey = 0;
				var maxval = 0;
				for (var [key, value] of map) {
					if (value > maxval) {
						maxkey = key;
						maxval = value;
					}
				}

				return maxkey;
			}

			function updateData(res) {
				console.log("Num to update = " + res);

				var updateItem = {
					id: '24fec1af-a25f-419f-abee-c98121da9c7d',
					num: res
				}

				tableRes
					.update(updateItem)
					.then(function (response) {
						console.log("Success, sent : " + response);
					}, function (error) {
						console.log("Error : " + error);
					});
			}

			// Script execution starts here

			table
				.read()
				.then(success, failure);

		  </script>
		  
	</body>

</html>
<!-- 

			function success(results) {
		  		//console.log("Read success.");
				var numItemsRead = results.length;

				for (var i = 0 ; i < results.length ; i++) {
					// Handling only the last line of the table
					if (i == results.length - 1) {
						var row = results[i].Text;
						var smsArray = row.match(/\[(.*?)\]/gi);

						var numArray = new Map();
				   		for (let i = 0; i < smsArray.length; i++) {
				   			let firstNum = smsArray[i].split(",")[0].split("[")[1];
				   			if (numArray.has(firstNum)) {
				   				numArray.set(firstNum, numArray.get(firstNum) + 1)
				   			} else {
				   				numArray.set(firstNum, 1)
				   			}
				   		}

				   		result = mostContacted(numArray);

				   		console.log("Checking last entry : " + result);				   		
				   		
				   		if (result != lastEntry) {
				   			console.log("- Found new entry, sending to result table -");
				   			sendData(result);
				   			lastEntry = result;
				   		}
					}
				}
			}

			function postSuccess() {
				intervalId = setInterval(function (j) {
					table
						.read()
						.then(success, failure);
				}, 3600000);
			}

			function sendData(res) {
				console.log("Num to send = " + res);

				return tableRes
					.insert( {num: res} )
					.then(function (response) {
						//console.log("Success : " + response);
					}, function (error) {
						//console.log("Error : " + error);
					});
			} -->